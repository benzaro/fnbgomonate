rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function - only checks if user is logged in
    function isAuthenticated() {
      return request.auth != null;
    }

    function isAnonymous() {
      return request.auth != null && request.auth.token.firebase.sign_in_provider == 'anonymous';
    }

    // Helper to get user data - used for role checks
    // IMPORTANT: These functions read from users collection, so they cannot be used
    // in rules for the users collection itself (would cause circular dependency)
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    function hasRole(role) {
      return isAuthenticated() &&
             getUserData().role == role &&
             getUserData().isActive == true;
    }

    function isSuperAdmin() {
      return hasRole('superadmin');
    }

    function isHR() {
      return hasRole('hr');
    }

    function isScanner() {
      return hasRole('scanner');
    }

    function isStaff() {
      return isSuperAdmin() || isHR() || isScanner();
    }

    // ==========================================
    // Users collection - SPECIAL HANDLING
    // ==========================================
    // This collection requires special rules because other rules
    // depend on reading from it. We cannot use role-based helper
    // functions here as they would create a circular dependency.
    match /users/{userId} {
      // TEMPORARY DEBUG: Allow any authenticated user to read any user doc
      // This helps diagnose if the issue is with rules or something else
      // TODO: Revert to stricter rules after debugging
      allow read: if request.auth != null;

      // Only superadmin can create/update/delete users
      allow create, update, delete: if request.auth != null &&
                                       get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'superadmin' &&
                                       get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isActive == true;
    }

    // ==========================================
    // Employees collection
    // ==========================================
    match /employees/{employeeId} {
      // Staff can read all employees, any authenticated user can read (for anonymous dashboard)
      allow read: if isStaff() || isAuthenticated();

      // SuperAdmin and HR can create employees
      allow create: if isSuperAdmin() || isHR();

      // Update rules:
      // - SuperAdmin/HR: full update
      // - Scanner: only tokenBalance (for redemption)
      // - Anonymous: only registrationStatus (for registration flow)
      allow update: if isSuperAdmin() || isHR() ||
                      (isScanner() &&
                       request.resource.data.diff(resource.data).affectedKeys().hasOnly(['tokenBalance'])) ||
                      (isAnonymous() &&
                       request.resource.data.diff(resource.data).affectedKeys().hasOnly(['registrationStatus']));

      // Only superadmin can delete
      allow delete: if isSuperAdmin();
    }

    // ==========================================
    // QR Codes collection
    // ==========================================
    match /qrCodes/{qrCodeId} {
      // Any authenticated user can read (needed for validation and employee dashboard)
      allow read: if isAuthenticated();

      // SuperAdmin and HR can create
      allow create: if isSuperAdmin() || isHR();

      // Only superadmin can delete
      allow delete: if isSuperAdmin();

      // Update rules:
      // - SuperAdmin/HR/Scanner: full update
      // - Anonymous: only registration fields
      allow update: if isSuperAdmin() || isHR() || isScanner() ||
                      (isAnonymous() &&
                       request.resource.data.diff(resource.data).affectedKeys().hasOnly(['isRegistered', 'registeredAt', 'registeredDeviceId']));
    }

    // ==========================================
    // Transactions collection
    // ==========================================
    match /transactions/{transactionId} {
      // Staff and authenticated users can read
      allow read: if isStaff() || isAuthenticated();

      // Only scanner can create transactions
      allow create: if isScanner();
    }

    // ==========================================
    // Event Config collection
    // ==========================================
    match /eventConfig/{configId} {
      allow read: if isAuthenticated();
      allow write: if isSuperAdmin();
    }

    // ==========================================
    // Audit Logs collection
    // ==========================================
    match /auditLogs/{logId} {
      allow read: if isSuperAdmin();
      allow write: if false; // Only backend/admin SDK can write
    }
  }
}
