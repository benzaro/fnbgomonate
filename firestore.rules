rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }

    function isAnonymous() {
      return request.auth != null && request.auth.token.firebase.sign_in_provider == 'anonymous';
    }

    // Safe version that doesn't cause circular dependency
    function getUserRole() {
      let userDoc = get(/databases/$(database)/documents/users/$(request.auth.uid));
      return userDoc.data.role;
    }

    function isSuperAdmin() {
      return isAuthenticated() &&
             getUserRole() == 'superadmin' &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isActive == true;
    }

    function isHR() {
      return isAuthenticated() &&
             getUserRole() == 'hr' &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isActive == true;
    }

    function isScanner() {
      return isAuthenticated() &&
             getUserRole() == 'scanner' &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isActive == true;
    }

    // Users collection
    match /users/{userId} {
      // Allow ANY authenticated user to read their own document (needed for login)
      // This is SAFE because request.auth.uid == userId prevents users from reading others' docs
      allow read: if request.auth.uid == userId;

      // For admin operations (create, update, delete), check custom claims or check against a hardcoded superadmin list
      // To avoid circular dependency, we don't use isSuperAdmin() for the users collection itself
      allow create, update, delete: if request.auth.uid != null &&
                                       get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'superadmin' &&
                                       get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isActive == true;
    }

    // Employees collection
    match /employees/{employeeId} {
      // Allow superadmin, HR to read all employees
      // Allow scanner to read employees (for redemption)
      // Allow anonymous users to read their own employee record (for dashboard)
      allow read: if isSuperAdmin() || isHR() || isScanner() || isAuthenticated();

      // Allow superadmin, HR to create employees
      allow create: if isSuperAdmin() || isHR();

      // Allow superadmin, HR to update fully
      // Allow scanner to update tokenBalance only (for redemption)
      // Allow anonymous users to update registrationStatus only (for registration)
      // Allow any anonymous user to update registrationStatus (cross-session registration)
      allow update: if isSuperAdmin() || isHR() ||
                      (isScanner() &&
                       request.resource.data.diff(resource.data).affectedKeys().hasOnly(['tokenBalance'])) ||
                      (isAnonymous() &&
                       request.resource.data.diff(resource.data).affectedKeys().hasOnly(['registrationStatus']));

      allow delete: if isSuperAdmin();
    }

    // QR Codes collection
    match /qrCodes/{qrCodeId} {
      // Allow authenticated users to read (for code validation and employee dashboard)
      allow read: if isAuthenticated();

      // Allow superadmin, HR to create/delete
      allow create: if isSuperAdmin() || isHR();
      allow delete: if isSuperAdmin();

      // Allow superadmin, HR to update fully
      // Allow anonymous users to update only registration fields
      // Allow scanner users to update for token redemption
      allow update: if isSuperAdmin() || isHR() || isScanner() ||
                      (isAnonymous() &&
                       request.resource.data.diff(resource.data).affectedKeys().hasOnly(['isRegistered', 'registeredAt', 'registeredDeviceId']));
    }

    // Transactions collection
    match /transactions/{transactionId} {
      // Allow superadmin, HR to read all transactions
      // Allow authenticated users to read transactions (for their own dashboard)
      allow read: if isSuperAdmin() || isHR() || isAuthenticated();
      allow create: if isScanner();
    }

    // Event Config collection
    match /eventConfig/{configId} {
      allow read: if isAuthenticated();
      allow write: if isSuperAdmin();
    }

    // Audit Logs collection
    match /auditLogs/{logId} {
      allow read: if isSuperAdmin();
      allow write: if false; // Only backend can write
    }
  }
}
